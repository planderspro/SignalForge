#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Run linting
echo "üìù Checking code style..."
npm run lint || exit 1

# Run TypeScript type checking
echo "üîß Checking TypeScript types..."
npm run typecheck || exit 1

# Run unit tests
echo "üß™ Running unit tests..."
npm run test:unit || exit 1

# Check for audio-specific issues
echo "üéµ Checking audio worklet files..."
if git diff --cached --name-only | grep -q "\.worklet\.(ts|js)$"; then
    echo "‚ö†Ô∏è  AudioWorklet files detected. Ensure they follow real-time constraints:"
    echo "   - No dynamic memory allocation in process() method"
    echo "   - No console.log or DOM access"
    echo "   - Keep processing lightweight for stable audio"
fi

# Check for large audio files
echo "üìÅ Checking for large files..."
git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
        if [ $size -gt 10485760 ]; then # 10MB
            echo "‚ùå Large file detected: $file ($size bytes)"
            echo "   Consider using Git LFS for audio files or excluding from repository"
            exit 1
        fi
    fi
done

echo "‚úÖ Pre-commit checks passed!"